name: Generate Docs to GH Pages

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'ESS-*.yml'

permissions:
  contents: write

jobs:
  generate_docs:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install AsyncAPI CLI
      run: npm install -g @asyncapi/cli
    
    - name: Discover ESS AsyncAPI files
      id: discover
      run: |
        # Find all ESS-*.yml files in the repository root
        FILES=$(ls ESS-*.yml 2>/dev/null || echo "")
        if [ -z "$FILES" ]; then
          echo "No ESS-*.yml files found"
          exit 1
        fi
        echo "Found files:"
        echo "$FILES"
        echo "files<<EOF" >> $GITHUB_OUTPUT
        echo "$FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Generate HTML documentation for each ESS file
      run: |
        mkdir -p generated-html
        
        # Loop through each ESS-*.yml file
        for file in ESS-*.yml; do
          if [ -f "$file" ]; then
            # Extract filename without extension
            basename="${file%.yml}"
            echo "Generating documentation for $file -> $basename/"
            
            # Generate HTML documentation using AsyncAPI CLI with latest html-template
            asyncapi generate fromTemplate "$file" @asyncapi/html-template@2.3.14 --output "generated-html/$basename" --force-write
          fi
        done
    
    - name: Generate landing page
      run: |
        # Extract repo name and URL
        REPO_NAME="${GITHUB_REPOSITORY##*/}"
        REPO_URL="https://github.com/$GITHUB_REPOSITORY"
        
        # Build document links
        DOCUMENT_LINKS=""
        for file in ESS-*.yml; do
          if [ -f "$file" ]; then
            basename="${file%.yml}"
            DOCUMENT_LINKS+="        <li><a href=\"./$basename/\">$basename</a></li>\n"
          fi
        done
        
        # Read template and replace placeholders
        cp .github/templates/landing-page.html generated-html/index.html
        sed -i "s|{{REPO_NAME}}|$REPO_NAME|g" generated-html/index.html
        sed -i "s|{{REPO_URL}}|$REPO_URL|g" generated-html/index.html
        sed -i "s|{{DOCUMENT_LINKS}}|$(echo -e "$DOCUMENT_LINKS" | sed 's/[&/\]/\\&/g')|g" generated-html/index.html
        
        echo "Landing page generated at generated-html/index.html"
    
    - name: Deploy to GH Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: gh-pages
        folder: generated-html
        clean: true
