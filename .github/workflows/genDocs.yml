name: Generate Docs to GH Pages

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'ESS-*.yml'

permissions:
  contents: write

jobs:
  generate_docs:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install AsyncAPI Generator
      run: |
        npm install -g @asyncapi/generator@2.4.1
        npm install -g @asyncapi/html-template@2.3.14
    
    - name: Discover ESS AsyncAPI files
      id: discover
      run: |
        # Find all ESS-*.yml files in the repository root
        FILES=$(ls ESS-*.yml 2>/dev/null || echo "")
        if [ -z "$FILES" ]; then
          echo "No ESS-*.yml files found"
          exit 1
        fi
        echo "Found files:"
        echo "$FILES"
        echo "files<<EOF" >> $GITHUB_OUTPUT
        echo "$FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Generate HTML documentation for each ESS file
      run: |
        mkdir -p generated-html
        
        # Loop through each ESS-*.yml file
        for file in ESS-*.yml; do
          if [ -f "$file" ]; then
            # Extract filename without extension
            basename="${file%.yml}"
            echo "Generating documentation for $file -> $basename/"
            
            # Generate HTML documentation using ag (AsyncAPI Generator CLI)
            ag "$file" @asyncapi/html-template@2.3.14 -o "generated-html/$basename" --force-write
          fi
        done
    
    - name: Generate landing page
      run: |
        cat > generated-html/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>AsyncAPI Documentation</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    max-width: 800px;
                    margin: 50px auto;
                    padding: 20px;
                    line-height: 1.6;
                }
                h1 {
                    color: #333;
                    border-bottom: 2px solid #333;
                    padding-bottom: 10px;
                }
                ul {
                    list-style-type: none;
                    padding: 0;
                }
                li {
                    margin: 10px 0;
                }
                a {
                    color: #0066cc;
                    text-decoration: none;
                    font-size: 18px;
                }
                a:hover {
                    text-decoration: underline;
                }
            </style>
        </head>
        <body>
            <h1>AsyncAPI Documentation</h1>
            <p>Available documentation:</p>
            <ul>
        EOF
        
        # Add links for each generated document
        for file in ESS-*.yml; do
          if [ -f "$file" ]; then
            basename="${file%.yml}"
            echo "                <li><a href=\"./$basename/\">$basename</a></li>" >> generated-html/index.html
          fi
        done
        
        cat >> generated-html/index.html << 'EOF'
            </ul>
        </body>
        </html>
        EOF
        
        echo "Landing page generated at generated-html/index.html"
    
    - name: Deploy to GH Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: gh-pages
        folder: generated-html
        clean: true
